#pragma rtGlobals=1		// Use modern global access method.#pragma IgorVersion=6.1//////////////////////////////////////////////////////// an empirical model containing two "lorentzian" functions if the exponents are = 2// - you get similar behavior for m!=n!=2, just not truly "Lorentzian"////// B. Hammouda OCT 2008////// updated for use with latest macros SRK Nov 2008////////////////////////////////////////////////////////Proc PlotTwoLorentzian(num,qmin,qmax)	Variable num=200, qmin=0.001, qmax=0.7	Prompt num "Enter number of data points for model: "	Prompt qmin "Enter minimum q-value (Å^-1) for model: " 	Prompt qmax "Enter maximum q-value (Å^-1) for model: "//	Make/O/D/n=(num) xwave_TwoLorentzian, ywave_TwoLorentzian	xwave_TwoLorentzian =  alog(log(qmin) + x*((log(qmax)-log(qmin))/num))	Make/O/D coef_TwoLorentzian = {10,100,3,1,10,2,0.1}			make/o/t parameters_TwoLorentzian = {"Lorentzian #1 scale","Correlation length #1 [A]","Lorentzian #1 exponent","Lorentzian #2 scale","Correlation length #2 [A]","Lorentzian #2 exponent","Bkg [1/cm]"}	Edit parameters_TwoLorentzian, coef_TwoLorentzian		Variable/G root:g_TwoLorentzian	g_TwoLorentzian := TwoLorentzian(coef_TwoLorentzian, ywave_TwoLorentzian, xwave_TwoLorentzian)	Display ywave_TwoLorentzian vs xwave_TwoLorentzian	ModifyGraph marker=29, msize=2, mode=4	ModifyGraph log=1,grid=1,mirror=2	Label bottom "q (Å\\S-1\\M) "	Label left "I(q) (cm\\S-1\\M)"	AutoPositionWindow/M=1/R=$(WinName(0,1)) $WinName(0,2)		AddModelToStrings("TwoLorentzian","coef_TwoLorentzian","parameters_TwoLorentzian","TwoLorentzian")//End////no input parameters are necessary, it MUST use the experimental q-values// from the experimental data read in from an AVE/QSIG data file////////////////////////////////////////////////////// - sets up a dependency to a wrapper, not the actual SmearedModelFunctionProc PlotSmearedTwoLorentzian(str)									String str	Prompt str,"Pick the data folder containing the resolution you want",popup,getAList(4)		// if any of the resolution waves are missing => abort	if(ResolutionWavesMissingDF(str))		//updated to NOT use global strings (in GaussUtils)		Abort	endif		SetDataFolder $("root:"+str)		// Setup parameter table for model function	Make/O/D smear_coef_TwoLorentzian = {10,100,3,1,10,2,0.1}			make/o/t smear_parameters_TwoLorentzian = {"Lorentzian #1 scale","Correlation length #1 [A]","Lorentzian #1 exponent","Lorentzian #2 scale","Correlation length #2 [A]","Lorentzian #2 exponent","Bkg [1/cm]"}	Edit smear_parameters_TwoLorentzian,smear_coef_TwoLorentzian					//display parameters in a table		// output smeared intensity wave, dimensions are identical to experimental QSIG values	// make extra copy of experimental q-values for easy plotting	Duplicate/O $(str+"_q") smeared_TwoLorentzian,smeared_qvals	SetScale d,0,0,"1/cm",smeared_TwoLorentzian						Variable/G gs_TwoLorentzian=0	gs_TwoLorentzian := fSmearedTwoLorentzian(smear_coef_TwoLorentzian,smeared_TwoLorentzian,smeared_qvals)	//this wrapper fills the STRUCT		Display smeared_TwoLorentzian vs smeared_qvals	ModifyGraph log=1,marker=29,msize=2,mode=4	Label bottom "q (Å\\S-1\\M)"	Label left "I(q) (cm\\S-1\\M)"	AutoPositionWindow/M=1/R=$(WinName(0,1)) $WinName(0,2)		SetDataFolder root:	AddModelToStrings("SmearedTwoLorentzian","smear_coef_TwoLorentzian","smear_parameters_TwoLorentzian","TwoLorentzian")End////AAO version, uses XOP if available// simply calls the original single point calculation with// a wave assignment (this will behave nicely if given point ranges)Function TwoLorentzian(cw,yw,xw) : FitFunc	Wave cw,yw,xw	#if exists("TwoLorentzianX")	yw = TwoLorentzianX(cw,xw)#else	yw = fTwoLorentzian(cw,xw)#endif	return(0)End//// unsmeared model calculation//Function fTwoLorentzian(w,x) : FitFunc	Wave w	Variable x		// variables are:								//[0] Lorentzian term scaling	//[1] Lorentzian screening length [A]	//[2] Lorentzian exponent	//[3] Lorentzian #2 term scaling	//[4] Lorentzian #2 screening length [A]	//[5] Lorentzian #2 exponent	//[6] background		Variable aa,LL1,nn,cc,LL2,mm,bgd	aa = w[0]	LL1=w[1]	nn = w[2]	cc = w[3]	LL2=w[4]	mm=w[5]	bgd=w[6]//	local variables	Variable inten, qval//	x is the q-value for the calculation	qval = x//	do the calculation and return the function value		inten = aa/(1+(qval*LL1)^nn) + cc/(1 + (qval*LL2)^mm) + bgd	Return (inten)	End///////////////////////////////////////////////////////////////// smeared model calculation//// you don't need to do anything with this function, as long as// your TwoLorentzian works correctly, you get the resolution-smeared// version for free.//// this is all there is to the smeared model calculation!Function SmearedTwoLorentzian(s) : FitFunc	Struct ResSmearAAOStruct &s//	the name of your unsmeared model (AAO) is the first argument	Smear_Model_20(TwoLorentzian,s.coefW,s.xW,s.yW,s.resW)	return(0)End///////////////////////////////////////////////////////////////// nothing to change here////wrapper to calculate the smeared model as an AAO-Struct// fills the struct and calls the ususal function with the STRUCT parameter//// used only for the dependency, not for fitting//Function fSmearedTwoLorentzian(coefW,yW,xW)	Wave coefW,yW,xW		String str = getWavesDataFolder(yW,0)	String DF="root:"+str+":"		WAVE resW = $(DF+str+"_res")		STRUCT ResSmearAAOStruct fs	WAVE fs.coefW = coefW		WAVE fs.yW = yW	WAVE fs.xW = xW	WAVE fs.resW = resW		Variable err	err = SmearedTwoLorentzian(fs)		return (0)End